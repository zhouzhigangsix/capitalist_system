# 跳空检测功能修改说明

## 修改概述

在 `strategy_b1.py` 中添加了第6个过滤条件，用于排除过去40天内有跳空缺口的股票。

---

## 代码修改位置

### 1. 新增函数：`has_gap_in_past_days()` (第331-368行)

**函数功能**：检查K线数据中过去N天是否存在跳空缺口

**跳空定义**：
- **向上跳空**：`当日最低价 > 前日最高价` (low[i] > high[i-1])
- **向下跳空**：`当日最高价 < 前日最低价` (high[i] < low[i-1])

**返回值**：
- `True`：检测到跳空 → 过滤掉该股票
- `False`：无跳空 → 保留该股票

**实现细节**：
```python
def has_gap_in_past_days(df, days=40):
    # 1. 边界检查：数据不足时返回False
    if df is None or len(df) < 2:
        return False

    # 2. 提取过去N天的数据
    start_idx = max(0, len(df) - days - 1)
    check_df = df.iloc[start_idx:]

    # 3. 遍历相邻K线检查跳空
    for i in range(1, len(check_df)):
        curr = check_df.iloc[i]      # 当日
        prev = check_df.iloc[i-1]    # 前日

        # 向上跳空检查
        if curr['low'] > prev['high']:
            return True

        # 向下跳空检查
        if curr['high'] < prev['low']:
            return True

    # 4. 未发现跳空
    return False
```

---

### 2. 修改条件判断：`analyze_stock()` (第386-406行)

**原有5个条件**：
- cond1: 股价 > 知行多空线
- cond2: KDJ J值 < 13
- cond3: 短期趋势线 > 多空线
- cond4: 振幅 < 4%
- cond5: 交易量 < 12日均量的52%

**新增第6个条件**：
```python
# 6. 过去40天无跳空缺口（避免有缺口的股票）
cond6 = not has_gap_in_past_days(df, days=40)

# 综合判断（需要同时满足全部6个条件）
if cond1 and cond2 and cond3 and cond4 and cond5 and cond6:
    # 执行后续逻辑...
```

---

## 逻辑流程

```
获取K线数据
    ↓
计算技术指标
    ↓
提取当日数据
    ↓
检查6个条件
    ├─ cond1：价格 > 多空线？
    ├─ cond2：J值 < 13？
    ├─ cond3：趋势线 > 多空线？
    ├─ cond4：振幅 < 4%？
    ├─ cond5：量 < 52%均量？
    └─ cond6：过去40天无跳空？ ← 【新增】
         │
         ├─ 调用 has_gap_in_past_days(df)
         ├─ 遍历过去40天K线
         ├─ 检查向上跳空：low > prev_high
         ├─ 检查向下跳空：high < prev_low
         └─ 返回 True/False
    ↓
全部条件满足 → 计算评分 → 保存结果
```

---

## 数据需求

函数使用的K线数据列（已有）：
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `open`: 开盘价

无需获取额外数据。

---

## 性能考虑

| 指标 | 说明 |
|------|------|
| **数据量** | 仅检查过去41行数据（days+1） |
| **时间复杂度** | O(n)，其中n=40 |
| **提前终止** | 一旦发现跳空立即返回，无需检查全部 |
| **额外开销** | 极小，单次检查 < 1ms |

---

## 测试场景

### 场景1：向上跳空
```
前日：high=10.5, low=10.0
今日：high=10.8, low=10.6
检查：10.6 > 10.5 ✓ → 发现向上跳空 → 返回True → 过滤
```

### 场景2：向下跳空
```
前日：high=10.5, low=10.0
今日：high=9.8, low=9.3
检查：9.8 < 10.0 ✓ → 发现向下跳空 → 返回True → 过滤
```

### 场景3：无跳空（正常K线）
```
前日：high=10.5, low=10.0
今日：high=10.7, low=10.2
检查：
  向上：10.2 > 10.5? ✗
  向下：10.7 < 10.0? ✗
→ 无跳空 → 返回False → 保留
```

---

## 代码变更总结

| 修改项 | 变更 |
|--------|------|
| **新增函数** | `has_gap_in_past_days(df, days=40)` |
| **新增条件** | cond6：过去40天无跳空 |
| **修改行** | 第331-368行（新函数），第403-406行（条件判断） |
| **文件** | `/Users/zhouzg/Project/tdx-api/strategy_b1.py` |
| **是否部署** | ❌ 否，待review确认后再部署 |

---

## 后续步骤

1. ✅ 代码修改完成
2. ⏳ 用户Review确认
3. ⏳ 本地测试验证
4. ⏳ 部署到服务器
5. ⏳ 运行选股，验证过滤效果
