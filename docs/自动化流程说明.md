# Alpha Hunter 自动化选股与回测流程说明

## 核心时间点

### 每日 22:08（晚上 10 点 8 分）
Cron 任务：`8 22 * * 1-5` 每个交易日自动执行

**时区**：Asia/Shanghai (CST, +0800) 北京时间

## 完整执行流程

### 第1步：触发选股 (22:08)
```
Cron Job 触发 → /opt/tdx-stock/scripts/run_strategy_cron.sh
                      ↓
                 python3 strategy_b1.py
```

**执行内容**：
- 获取今日全市场 5462 只股票K线数据
- 应用 B1 策略过滤条件（5个条件）
- 计算量化评分（100分制）
- **保存今日选股结果** 到数据库 `strategy_results` 表
  - 日期字段 = 今日日期（如 12-03）
  - 包含：代码、名称、价格、KDJ值、振幅、量比、综合评分等

**示例**：12月3日晚 20:08 执行 → 数据库新增 12-03 选股记录

---

### 第2步：自动计算前一日回测 (20:08 之后)
```
strategy_b1.py main() 函数 (第482行)
        ↓
   run_previous_day_backtest()
        ↓
   查询前一日选股 (如 12-02) → 获取前10只股票
        ↓
   获取今日收盘价 (12-03 close)
        ↓
   计算收益率：(12-03 close - 12-02 close) / 12-02 close * 100
        ↓
   统计盈利股票、亏损股票、平均收益、胜率等
        ↓
   保存回测结果 到 backtest_results 表
      （日期字段 = 卖出日期 = 12-03）
```

**执行逻辑**：
- 获取昨日（12-02）评分前10的选股
- 用今日（12-03）收盘价计算虚拟卖出收益
- 保存详细的盈亏明细 JSON 数据（win_stocks 和 lose_stocks）

---

## 数据库状态变化

### 时间点：2025-12-03 20:08 执行后

#### strategy_results 表（选股结果）
```
日期       | 数量 | 说明
-----------|------|------------------
2025-11-28 | N  | 周五选股 (已保存)
2025-12-01 | M  | 周一选股 (已保存)
2025-12-02 | K  | 周二选股 (已保存)
2025-12-03 | X  | 周三选股 (新增 ✓)
```

#### backtest_results 表（回测结果）
```
日期       | 说明
-----------|---------------------------
2025-12-01 | 11-28 选股，12-01 卖出 (已保存)
2025-12-02 | 12-01 选股，12-02 卖出 (已保存)
2025-12-03 | 12-02 选股，12-03 卖出 (新增 ✓)
```

---

## 前端界面对应表现

### 用户选择 12-02，前端自动显示回测卡片

**流程**：
```
前端选择日期 12-02
      ↓
JavaScript 计算下一个交易日 = 12-03
（跳过周末：getDay() >= 1 && <= 5）
      ↓
API 查询 /api/backtest/results?strategy=b1&date=2025-12-03
      ↓
后端返回 12-02 选股→12-03 卖出的回测数据 ✓
      ↓
前端显示：
  - 日均收益率：±X.XX%
  - 胜率：Y%
  - 盈/亏比：Z
  - 详细按钮 (盈利/亏损股票列表)
```

### 用户选择 12-03（20:08 之后），前端显示回测卡片

**流程**：
```
前端选择日期 12-03
      ↓
JavaScript 计算下一个交易日 = 12-04
      ↓
API 查询 /api/backtest/results?strategy=b1&date=2025-12-04
      ↓
12-04 回测数据（12-03 选股，12-04 卖出）
（这取决于 12-04 是否已收盘）
```

---

## 常见场景

### 场景1：周五 20:08 执行
```
12-03 周三 20:08 执行
  ✓ 保存 12-03 选股数据
  ✓ 计算 12-02→12-03 回测（保存为日期 12-03）

12-05 周五 20:08 执行
  ✓ 保存 12-05 选股数据
  ✓ 计算 12-04→12-05 回测（保存为日期 12-05）

12-08 周一 20:08 执行（跳过周末）
  ✓ 保存 12-08 选股数据
  ✓ 计算 12-05→12-08 回测（保存为日期 12-08）
  （自动跳过周末，周五选股 → 周一卖出）
```

### 场景2：今日还未收盘
```
当天 15:00 刷新前端
  - 选股数据：显示（昨日选股 ✓）
  - 回测卡片：隐藏（今日收盘价未取得）

当天 20:08 cron 执行
  - 使用当日收盘价计算昨日选股的回测
  - 保存今日新选股

20:08 之后刷新前端
  - 选股数据：显示今日选股 ✓
  - 回测卡片：显示昨日选股的回测 ✓
```

---

## 时间戳一致性验证

### JavaScript 日期计算（strategy.html 第706-713行）
```javascript
const selectDate = new Date(selectedDate);
let nextDate = new Date(selectDate);

do {
    nextDate.setDate(nextDate.getDate() + 1);
    const dayOfWeek = nextDate.getDay();
    // 交易日：周一(1)到周五(5)
    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
        break;
    }
} while (true);

// 得到的 nextDate 即为下一个交易日
const nextDateStr = nextDate.toISOString().split('T')[0];
// 查询 /api/backtest/results?strategy=b1&date=nextDateStr
```

**验证结果**：
- 11-28（周五）→ 12-01（周一）✓
- 12-01（周一）→ 12-02（周二）✓
- 12-02（周二）→ 12-03（周三）✓

---

## 总结

**回答用户问题**：
> "今天我晚上 10 点过 8 分会自动给我进行选股然后拿今天的收盘信息进行回测吗？"

**答案：是的，完全自动化！** ✅

具体来说：
1. **20:08 自动执行选股**：对今日市场数据运行 B1 策略，保存今日选股结果
2. **20:08 自动执行回测**：计算昨日选股的今日收益（次日卖出），保存回测结果
3. **前端自动显示**：用户刷新后，根据选择的日期自动计算下一交易日，查询对应回测数据

**无需手动操作**，系统完全自动化运行。

---

## 日志查看

查看每日执行日志：
```bash
tail -f /var/log/tdx-stock/strategy_YYYYMMDD.log
```

查看数据库结果：
```bash
sqlite3 /opt/tdx-stock/stocks.db "SELECT * FROM strategy_results ORDER BY date DESC LIMIT 5;"
sqlite3 /opt/tdx-stock/stocks.db "SELECT * FROM backtest_results ORDER BY date DESC LIMIT 5;"
```
