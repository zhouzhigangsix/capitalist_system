# 自动化流程时序图

## 每日 22:08 执行时序

```
时间点：2025-12-03 22:08:00

┌─────────────────────────────────────────────────────────────────┐
│                    Cron Job 触发                                 │
│           (8 22 * * 1-5 - 每个交易日晚 22:08)                   │
│           时区：Asia/Shanghai (CST, +0800)                       │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│        /opt/tdx-stock/scripts/run_strategy_cron.sh              │
│                 (Cron 脚本包装器)                                │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│           python3 /opt/tdx-stock/strategy_b1.py                 │
│                  (主策略脚本)                                    │
└─────────────────┬───────────────────────────────────────────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
    [部分1]           [部分2]
  选股与保存         回测计算

    ┌─────────────┐     ┌──────────────┐
    │ 1.初始化DB  │     │ 1.加载股票名 │
    │             │     │   称缓存      │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────┐     ┌──────────────┐
    │ 2.获取全市  │     │ 2.获取前3天  │
    │   场股票    │     │   内有选股   │
    │ (5462只)    │     │   的日期     │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────┐     ┌──────────────┐
    │ 3.并发K线   │     │ 3.遍历这些   │
    │   数据获取  │     │   日期执行   │
    │ (10线程)    │     │   回测       │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────┐     ┌──────────────┐
    │ 4.计算指标  │     │ 4.获取该日期 │
    │   (MA,KDJ   │     │   评分前10   │
    │    等)      │     │   的股票     │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────┐     ┌──────────────┐
    │ 5.策略过滤  │     │ 5.逐只获取   │
    │   (5个条件) │     │   次日收盘价 │
    │             │     │   (跳过周末) │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────┐     ┌──────────────┐
    │ 6.计算评分  │     │ 6.计算盈亏   │
    │ (100分制)   │     │   统计胜率   │
    │             │     │             │
    └────────┬────┘     └──────┬───────┘
             │                 │
             ▼                 ▼
    ┌─────────────────────────────┐
    │   7.保存结果到数据库         │
    │   strategy_results 表        │
    │   date = 2025-12-03          │
    │   (包含：代码、名称、价格、  │
    │    KDJ值、振幅、量比、       │
    │    综合评分等)               │
    └────────┬────────────────────┘
             │
             └──────────┬──────────┘
                        ▼
             ┌─────────────────────┐
             │ 8.保存回测结果      │
             │ backtest_results 表 │
             │ date = 2025-12-03   │
             │ (12-02选股→12-03卖) │
             │ (包含：win_stocks   │
             │  lose_stocks详情)   │
             └────────┬────────────┘
                      │
                      ▼
             ┌─────────────────────┐
             │  20:08 执行完毕 ✓   │
             │  选股数据已更新      │
             │  回测数据已更新      │
             └─────────────────────┘

时间：通常 3-5 分钟完成全部扫描和计算
```

---

## 前端界面响应流程

```
用户操作：选择日期 12-02 并点击"执行筛选"
                    │
                    ▼
            ┌──────────────────┐
            │ 前端 JavaScript  │
            │ loadResults()    │
            │ &                │
            │ loadBacktest     │
            │ Results()        │
            └────────┬─────────┘
                     │
         ┌───────────┼───────────┐
         │                       │
         ▼                       ▼
    [筛选结果]            [回测结果]

    API: /api/             API: /api/
    strategy/results?      backtest/
    strategy=b1&           results?
    date=2025-12-02        strategy=b1&
         │                 date=NEXT_
         │                 TRADING_DAY
         ▼                       │
    ┌─────────────┐       ┌─────▼─────┐
    │ 返回该日期  │       │ JS计算下一 │
    │ 的全部选股  │       │ 交易日     │
    │ 数据        │       │            │
    └─────────────┘       └──┬──────┬──┘
         │                    │      │
         ▼                    ▼      ▼
    ┌──────────────────────────────────┐
    │ 判断是否是今天，且未到 20:08      │
    │ (检查当前时间是否在 20:08 之前)  │
    │                                  │
    │ 如果是：显示等待提示 ⏰           │
    │ 如果否：查询下一交易日的回测数据  │
    └───────────┬────────────────────┬─┘
                │                    │
         ┌──────▼──────┐      ┌──────▼──────┐
         │ 12-02 不是  │      │ 12-03 是今  │
         │ 今天        │      │ 天，且超过  │
         │             │      │ 20:08       │
         ▼             ▼      ▼             ▼
    ┌─────────┐   ┌─────────────────────┐
    │查询12-03│   │查询12-04的回测数据  │
    │的回测   │   │(今天选股→明天卖)    │
    │数据     │   │                     │
    │(12-02选 │   │如果今天未收盘，      │
    │→12-03卖)   │则返回空，自动隐藏卡片│
    └────┬────┘   └──────────┬──────────┘
         │                   │
         ▼                   ▼
    ┌──────────────────────────────┐
    │  前端渲染结果                 │
    │                              │
    │ ┌────────────────────────┐   │
    │ │ [选股结果表格]         │   │
    │ │ - 综合评分 / 股票代码  │   │
    │ │ - 名称 / 最新价格      │   │
    │ │ - KDJ.J / 日振幅       │   │
    │ │ - 量比 / 趋势强度      │   │
    │ │ - 信号日期 / 操作按钮  │   │
    │ └────────────────────────┘   │
    │                              │
    │ ┌────────────────────────┐   │
    │ │ [回测统计卡片] (可选)  │   │
    │ │ - 日均收益率：±X.XX%   │   │
    │ │ - 胜率：Y%             │   │
    │ │ - 盈/亏比：Z           │   │
    │ │ - 有效样本数：N        │   │
    │ │ - 详细按钮（盈亏明细）│   │
    │ └────────────────────────┘   │
    │                              │
    │ ┌────────────────────────┐   │
    │ │ [数据分析图表]         │   │
    │ │ - 评分分布直方图       │   │
    │ │ - 选股数量趋势折线图   │   │
    │ └────────────────────────┘   │
    └──────────────────────────────┘
```

---

## 周末处理示例

```
场景：周五执行 vs 周末
====================================================

12-05 周五 20:08 执行
  ├─ 保存 12-05 选股数据 ✓
  └─ 计算 12-04→12-05 回测 ✓

12-06 周六（无市场，无执行）

12-07 周日（无市场，无执行）

12-08 周一 20:08 执行
  ├─ 保存 12-08 选股数据 ✓
  └─ 计算 12-05→12-08 回测 ✓
     （自动跳过周末的周六周日）

用户前端体验：
  选择 12-05 日期
    → 计算下一交易日：跳过 12-06(六) 和 12-07(日) → 得到 12-08
    → 查询 12-08 的回测数据（12-05 选股 → 12-08 卖出）
    → 显示回测结果
```

---

## 关键时间戳验证

```javascript
// strategy.html 中的日期计算逻辑
const selectDate = new Date(selectedDate);  // 用户选择的日期，如 12-02
let nextDate = new Date(selectDate);

do {
    nextDate.setDate(nextDate.getDate() + 1);  // 日期 +1
    const dayOfWeek = nextDate.getDay();       // 获取星期
    // getDay() 返回值：0=周日, 1=周一, ..., 6=周六
    if (dayOfWeek >= 1 && dayOfWeek <= 5) {    // 如果是周一到周五
        break;  // 找到下一交易日，退出循环
    }
} while (true);

const nextDateStr = nextDate.toISOString().split('T')[0];
// nextDateStr 就是下一个交易日，如 12-03

// 数据库查询：获取 nextDateStr 对应的回测数据
fetch(`/api/backtest/results?strategy=b1&date=${nextDateStr}`)
```

**验证结果**：
```
输入 12-02（周二）→ 计算结果 12-03（周三）✓
输入 12-03（周三）→ 计算结果 12-04（周四）✓
输入 12-04（周四）→ 计算结果 12-05（周五）✓
输入 12-05（周五）→ 计算结果 12-08（周一）✓ （跳过周末）
```
