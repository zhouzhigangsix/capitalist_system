# K线前复权功能更新说明

## 📋 更新内容

### ✅ 已实现功能

**默认使用前复权数据**，适用于以下K线类型：

1. **日K线（day）** - 默认前复权 ✅
2. **周K线（week）** - 默认前复权 ✅  
3. **月K线（month）** - 默认前复权 ✅

**分钟K线保持不复权**（当天数据无需复权）：
- 1分钟K线（minute1）
- 5分钟K线（minute5）
- 15分钟K线（minute15）
- 30分钟K线（minute30）
- 60分钟/小时K线（hour）

## 🔧 技术实现

### 数据来源
- **前复权数据**：通过同花顺API获取（`extend.GetTHSDayKline`）
- **降级方案**：如果同花顺API失败，自动降级使用通达信不复权数据

### 修改文件
1. `web/server.go` - 主要K线接口
2. `web/server_api_extended.go` - 扩展API接口

### 核心函数
```go
// 获取前复权日K线
func getQfqKlineDay(code string) (*protocol.KlineResp, error)

// 日K线转周K线
func convertToWeekKline(dayKline *protocol.KlineResp) *protocol.KlineResp

// 日K线转月K线
func convertToMonthKline(dayKline *protocol.KlineResp) *protocol.KlineResp
```

## 📡 影响的API接口

### 1. 获取K线数据
```
GET /api/kline?code=000001&type=day
```
**变化**：日K线现在返回前复权数据

### 2. 获取历史K线
```
GET /api/kline-history?code=000001&type=day&limit=100
```
**变化**：日/周/月K线现在返回前复权数据

### 3. 获取股票综合信息
```
GET /api/stock-info?code=000001
```
**变化**：内部的日K线数据现在使用前复权

## ✨ 前复权的优势

### 什么是前复权？
前复权是指保持当前价格不变，向前推算历史价格的复权方式。

### 为什么使用前复权？
1. **消除除权缺口**：历史K线图更连续，无跳空
2. **技术分析准确**：均线、指标计算更准确
3. **回测更真实**：历史价格反映真实投资收益
4. **行业标准**：大多数交易软件默认使用前复权

### 示例对比

**不复权数据（除权前）**：
- 2024-05-10: 10元（10送10除权）
- 2024-05-11: 5元（除权后）
- ❌ K线出现50%跳空缺口

**前复权数据**：
- 2024-05-10: 5元（调整后）
- 2024-05-11: 5元
- ✅ K线连续，真实反映投资收益

## 🚀 部署步骤

```bash
# 1. 停止容器
docker-compose down

# 2. 重新构建（包含前复权功能）
docker-compose build --no-cache

# 3. 启动容器
docker-compose up -d

# 4. 验证日志
docker-compose logs -f stock-web
```

## 🧪 测试验证

### 测试前复权功能
```bash
# 获取平安银行日K线（前复权）
curl "http://localhost:8080/api/kline?code=000001&type=day"

# 获取贵州茅台日K线（前复权）
curl "http://localhost:8080/api/kline?code=600519&type=day"
```

### 预期结果
- K线数据连续，无异常跳空
- 价格与同花顺、通达信前复权数据一致
- 如果同花顺API失败，会在日志中看到降级提示

## 📝 注意事项

1. **网络要求**：需要能访问同花顺API（`d.10jqka.com.cn`）
2. **降级机制**：如果同花顺API失败，自动使用不复权数据
3. **数据一致性**：前复权数据与通达信一致
4. **分钟K线**：保持不复权，因为当天内无除权除息

## 🔍 故障排查

### 如果返回不复权数据
检查日志是否有以下提示：
```
获取前复权数据失败，使用不复权数据: xxx
```

**可能原因**：
1. 无法访问同花顺API
2. 股票代码不存在
3. 网络问题

**解决方案**：
- 检查网络连接
- 验证防火墙规则
- 确认股票代码正确

## 📚 相关文档

- 原始项目文档：`README.md`
- API接口文档：`API_接口文档.md`
- Docker部署：`DOCKER_部署完成.md`
- 时区修复说明：见Git提交记录

---

**更新时间**：2025-11-05  
**版本**：v1.1.0（前复权功能）

