<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é€‰è‚¡ä¸­å¿ƒ | Alpha Hunter</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .badge-hot {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .badge-cool {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
            display: block;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-value.positive {
            color: var(--success-color);
        }

        .stat-value.negative {
            color: var(--danger-color);
        }

        .stat-trend {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div style="position: absolute; left: 0; top: 0;">
                <a href="index.html" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    è¿”å›è¡Œæƒ…ä¸­å¿ƒ
                </a>
            </div>
            <h1>Alpha Hunter</h1>
            <p class="subtitle">æ™ºèƒ½é‡åŒ–é€‰è‚¡ç­–ç•¥ä¸­å¿ƒ</p>
        </header>

        <!-- ç­›é€‰æ§åˆ¶å° -->
        <div class="filter-section">
            <div class="filter-item">
                <label>ç­–ç•¥æ¨¡å‹</label>
                <select id="strategySelect">
                    <option value="b1">B1 æˆ˜æ³• (å¤šç©ºçº¿çªç ´ + KDJè¶…å–)</option>
                </select>
            </div>
            <div class="filter-item">
                <label>å›æµ‹/æŸ¥è¯¢æ—¥æœŸ</label>
                <input type="date" id="dateSelect">
            </div>
            <div style="flex: 1;"></div>
            <button onclick="loadResults()" class="btn-primary">
                æ‰§è¡Œç­›é€‰
            </button>
        </div>

        <!-- å›æµ‹ç»“æœå¡ç‰‡ -->
        <div id="backtestCard" class="card" style="margin-bottom: 20px; display: none;">
            <div class="card-header">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="color: var(--success-color);">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    å‰æ—¥å›æµ‹æ”¶ç›Š
                </h2>
                <p class="subtitle" id="backtestDate">åŠ è½½ä¸­...</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <!-- æ—¥å‡æ”¶ç›Š -->
                    <div class="stat-card">
                        <div class="stat-label">
                            æ—¥å‡æ”¶ç›Šç‡
                            <button id="detailsBtn" onclick="showBacktestDetails()" style="margin-left: 8px; padding: 2px 8px; font-size: 0.75rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">è¯¦ç»†</button>
                        </div>
                        <div class="stat-value" id="avgReturn" style="font-size: 2rem;">--</div>
                        <div class="stat-trend" id="avgReturnTrend"></div>
                    </div>
                    <!-- èƒœç‡ -->
                    <div class="stat-card">
                        <div class="stat-label">èƒœç‡</div>
                        <div class="stat-value" id="winRate" style="font-size: 2rem;">--</div>
                        <div class="stat-trend" id="winRateTrend"></div>
                    </div>
                    <!-- ç›ˆåˆ©/äºæŸæ¯” -->
                    <div class="stat-card">
                        <div class="stat-label">ç›ˆ/äºæ¯”</div>
                        <div class="stat-value" id="winLoseRatio" style="font-size: 2rem;">--</div>
                        <div class="stat-trend" id="winLoseTrend"></div>
                    </div>
                    <!-- æœ‰æ•ˆæ ·æœ¬ -->
                    <div class="stat-card">
                        <div class="stat-label">æœ‰æ•ˆæ ·æœ¬æ•°</div>
                        <div class="stat-value" id="validCount" style="font-size: 2rem;">--</div>
                        <div class="stat-trend" id="validCountTrend"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯è§†åŒ–å¡ç‰‡ -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="color: var(--primary-color);">
                        <path d="M3 3v18h18" />
                        <path d="M18 17V9" />
                        <path d="M13 17V5" />
                        <path d="M8 17v-3" />
                    </svg>
                    æ•°æ®åˆ†æ
                </h2>
                <p class="subtitle">è¯„åˆ†åˆ†å¸ƒä¸è¶‹åŠ¿åˆ†æ</p>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- è¯„åˆ†åˆ†å¸ƒå›¾ -->
                    <div>
                        <h3 style="font-size: 0.95rem; margin-bottom: 15px; color: var(--text-secondary);">è¯„åˆ†åˆ†å¸ƒ</h3>
                        <div id="scoreDistChart" style="height: 300px;"></div>
                    </div>
                    <!-- å†å²è¶‹åŠ¿å›¾ -->
                    <div>
                        <h3 style="font-size: 0.95rem; margin-bottom: 15px; color: var(--text-secondary);">é€‰è‚¡æ•°é‡è¶‹åŠ¿</h3>
                        <div id="trendChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºå¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="color: var(--primary-color);">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <path d="M22 4L12 14.01l-3-3" />
                    </svg>
                    ç­›é€‰ç»“æœ
                    <span id="resultCount"
                        style="font-size: 0.9rem; color: var(--text-secondary); margin-left: 12px; font-weight: 400;">
                        åŠ è½½ä¸­...
                    </span>
                </h2>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" onclick="exportCSV()">å¯¼å‡º CSV</button>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>ç»¼åˆè¯„åˆ†</th>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>åç§°</th>
                            <th>æœ€æ–°ä»·æ ¼</th>
                            <th>KDJ.J æŒ‡æ ‡</th>
                            <th>æ—¥æŒ¯å¹…</th>
                            <th>é‡æ¯”</th>
                            <th>è¶‹åŠ¿å¼ºåº¦</th>
                            <th>ä¿¡å·æ—¥æœŸ</th>
                            <th style="text-align: right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        <!-- æ•°æ®æ³¨å…¥åŒº -->
                    </tbody>
                </table>
            </div>
        </div>

    <!-- å›æµ‹è¯¦æƒ…å¼¹çª— -->
    <div id="backtestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.25rem;">å›æµ‹è¯¦ç»†ä¿¡æ¯</h3>
                <button onclick="closeBacktestDetails()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <div style="padding: 20px;">
                <!-- ç›ˆåˆ©è‚¡ç¥¨ -->
                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--success-color); margin-bottom: 12px; font-size: 1rem;">
                        ğŸ“ˆ ç›ˆåˆ©è‚¡ç¥¨ (<span id="winStocksCount">0</span>)
                    </h4>
                    <div id="winStocksList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- äºæŸè‚¡ç¥¨ -->
                <div>
                    <h4 style="color: var(--danger-color); margin-bottom: 12px; font-size: 1rem;">
                        ğŸ“‰ äºæŸè‚¡ç¥¨ (<span id="loseStocksCount">0</span>)
                    </h4>
                    <div id="loseStocksList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- åŠ è½½é®ç½© -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: white; font-weight: 500;">æ­£åœ¨æ‰«æå…¨å¸‚åœºæ•°æ®...</p>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('dateSelect').valueAsDate = new Date();

        let currentData = [];

        async function loadResults() {
            const strategy = document.getElementById('strategySelect').value;
            const date = document.getElementById('dateSelect').value;

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©ä»Šå¤©ä¸”åœ¨20:08ä¹‹å‰
            const today = new Date().toISOString().split('T')[0];
            const currentTime = new Date();
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();

            if (date === today && (currentHour < 20 || (currentHour === 20 && currentMinute < 8))) {
                // æ˜¾ç¤ºç­‰å¾…æç¤º
                const tbody = document.getElementById('resultBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <span class="empty-icon">â°</span>
                                <p>ç­‰å¾…æ•°æ®æ›´æ–°</p>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;">
                                    æ¯å¤© 20:08 è‡ªåŠ¨æ›´æ–°å½“æ—¥é€‰è‚¡æ•°æ®å’Œå›æµ‹ç»“æœ
                                </p>
                            </div>
                        </td>
                    </tr>`;
                document.getElementById('resultCount').textContent = '(ç­‰å¾…æ›´æ–°)';
                // åŒæ—¶åŠ è½½å›æµ‹ç»“æœï¼ˆä¹Ÿä¼šæ˜¾ç¤ºç­‰å¾…æç¤ºï¼‰
                loadBacktestResults();
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(`/api/strategy/results?strategy=${strategy}&date=${date}`);
                const res = await response.json();

                if (res.code === 0) {
                    currentData = res.data;
                    renderTable(res.data);
                    // åŒæ—¶åŠ è½½å›æµ‹ç»“æœ
                    loadBacktestResults();
                } else {
                    alert('æŸ¥è¯¢å¤±è´¥: ' + res.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€');
            } finally {
                showLoading(false);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('resultBody');
            const countSpan = document.getElementById('resultCount');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <span class="empty-icon">ğŸ“­</span>
                                <p>è¯¥æ—¥æœŸä¸‹æœªå‘ç°ç¬¦åˆç­–ç•¥çš„æ ‡çš„</p>
                            </div>
                        </td>
                    </tr>`;
                countSpan.textContent = '(0)';
                return;
            }

            countSpan.textContent = `(å…±å‘ç° ${data.length} åªæ ‡çš„)`;

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    window.location.href = `index.html?code=${item.code}`;
                };

                // æ ¼å¼åŒ–æ•°æ®
                const score = item.score || 0;
                const scoreLevel = item.score_level || 'â­';
                const jValClass = item.j_val < 0 ? 'tag-success' : (item.j_val > 80 ? 'tag-danger' : '');
                const volClass = item.vol_ratio > 0.5 ? 'badge-cool' : 'badge-cool';
                const trendStrength = item.trend_strength || 0;

                // è¯„åˆ†é¢œè‰²
                let scoreColor = '#64748b';
                if (score >= 90) scoreColor = '#10b981';
                else if (score >= 80) scoreColor = '#22c55e';
                else if (score >= 70) scoreColor = '#3b82f6';
                else if (score >= 60) scoreColor = '#f59e0b';

                tr.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.4rem; font-weight: 700; color: ${scoreColor};">${score.toFixed(0)}</span>
                            <span style="font-size: 0.9rem;">${scoreLevel}</span>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">${item.score_detail || ''}</div>
                    </td>
                    <td><span class="stock-code">${item.code}</span></td>
                    <td style="font-weight: 600;">${item.name || '--'}</td>
                    <td class="price">${(item.price / 100).toFixed(2)}</td>
                    <td><span class="tag ${jValClass}">${item.j_val.toFixed(2)}</span></td>
                    <td>${item.amplitude.toFixed(2)}%</td>
                    <td><span class="status-badge ${volClass}">${(item.vol_ratio * 100).toFixed(0)}%</span></td>
                    <td>${trendStrength >= 0 ? '+' : ''}${trendStrength.toFixed(2)}%</td>
                    <td style="color: var(--text-secondary);">${item.date}</td>
                    <td style="text-align: right;">
                        <button class="action-btn" onclick="window.location.href='index.html?code=${item.code}'">
                            åˆ†æ
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°å›¾è¡¨
            renderCharts(data);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function exportCSV() {
            if (!currentData || currentData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const headers = ['ä»£ç ', 'åç§°', 'ä»·æ ¼', 'Jå€¼', 'æŒ¯å¹…', 'é‡æ¯”', 'æ—¥æœŸ'];
            const csvContent = [
                headers.join(','),
                ...currentData.map(row => [
                    row.code,
                    row.name || '',
                    row.price,
                    row.j_val,
                    row.amplitude,
                    row.vol_ratio,
                    row.date
                ].join(','))
            ].join('\n');

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `strategy_results_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderCharts(data) {
            if (!data || data.length === 0) return;

            renderScoreDistribution(data);
            renderTrendChart();
        }

        // è¯„åˆ†åˆ†å¸ƒç›´æ–¹å›¾
        function renderScoreDistribution(data) {
            const chart = echarts.init(document.getElementById('scoreDistChart'));

            // ç»Ÿè®¡å„åˆ†æ•°æ®µçš„æ•°é‡
            const scoreRanges = [
                { name: '0-50', min: 0, max: 50, count: 0 },
                { name: '51-60', min: 51, max: 60, count: 0 },
                { name: '61-70', min: 61, max: 70, count: 0 },
                { name: '71-80', min: 71, max: 80, count: 0 },
                { name: '81-90', min: 81, max: 90, count: 0 },
                { name: '91-100', min: 91, max: 100, count: 0 }
            ];

            data.forEach(item => {
                const score = item.score || 0;
                for (let range of scoreRanges) {
                    if (score >= range.min && score <= range.max) {
                        range.count++;
                        break;
                    }
                }
            });

            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#94a3b8'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    borderColor: '#334155',
                    textStyle: {
                        color: '#e2e8f0'
                    }
                },
                grid: {
                    left: '10%',
                    right: '5%',
                    bottom: '15%',
                    top: '10%'
                },
                xAxis: {
                    type: 'category',
                    data: scoreRanges.map(r => r.name),
                    axisLine: {
                        lineStyle: { color: '#334155' }
                    },
                    axisLabel: {
                        color: '#94a3b8'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: { color: '#334155' }
                    },
                    splitLine: {
                        lineStyle: { color: '#1e293b' }
                    },
                    axisLabel: {
                        color: '#94a3b8'
                    }
                },
                series: [{
                    name: 'è‚¡ç¥¨æ•°é‡',
                    type: 'bar',
                    data: scoreRanges.map(r => r.count),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#3b82f6' },
                            { offset: 1, color: '#1d4ed8' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#60a5fa' },
                                { offset: 1, color: '#3b82f6' }
                            ])
                        }
                    }
                }]
            };

            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // å†å²è¶‹åŠ¿å›¾
        async function renderTrendChart() {
            const chart = echarts.init(document.getElementById('trendChart'));

            try {
                // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
                const today = new Date();
                const dates = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]);
                }

                const strategy = document.getElementById('strategySelect').value;
                const promises = dates.map(date =>
                    fetch(`/api/strategy/results?strategy=${strategy}&date=${date}`)
                        .then(res => res.json())
                        .then(data => ({ date, count: data.code === 0 ? (data.data?.length || 0) : 0 }))
                        .catch(() => ({ date, count: 0 }))
                );

                const results = await Promise.all(promises);

                const option = {
                    backgroundColor: 'transparent',
                    textStyle: {
                        color: '#94a3b8'
                    },
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        borderColor: '#334155',
                        textStyle: {
                            color: '#e2e8f0'
                        }
                    },
                    grid: {
                        left: '10%',
                        right: '5%',
                        bottom: '15%',
                        top: '10%'
                    },
                    xAxis: {
                        type: 'category',
                        data: results.map(r => r.date.slice(5)),
                        axisLine: {
                            lineStyle: { color: '#334155' }
                        },
                        axisLabel: {
                            color: '#94a3b8'
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLine: {
                            lineStyle: { color: '#334155' }
                        },
                        splitLine: {
                            lineStyle: { color: '#1e293b' }
                        },
                        axisLabel: {
                            color: '#94a3b8'
                        }
                    },
                    series: [{
                        name: 'é€‰è‚¡æ•°é‡',
                        type: 'line',
                        data: results.map(r => r.count),
                        smooth: true,
                        lineStyle: {
                            color: '#10b981',
                            width: 3
                        },
                        itemStyle: {
                            color: '#10b981'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(16, 185, 129, 0.3)' },
                                { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                            ])
                        }
                    }]
                };

                chart.setOption(option);
                window.addEventListener('resize', () => chart.resize());
            } catch (error) {
                console.error('Error loading trend data:', error);
            }
        }

        // åŠ è½½å›æµ‹ç»“æœ
        async function loadBacktestResults() {
            const strategy = document.getElementById('strategySelect').value;
            const selectedDate = document.getElementById('dateSelect').value;

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ—¥æœŸ
            if (!selectedDate) {
                document.getElementById('backtestCard').style.display = 'none';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            const currentTime = new Date();
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();

            // å¦‚æœé€‰æ‹©çš„æ˜¯ä»Šå¤©ï¼Œä¸”å½“å‰æ—¶é—´åœ¨20:08ä¹‹å‰ï¼Œæ˜¾ç¤ºæç¤º
            if (selectedDate === today && (currentHour < 20 || (currentHour === 20 && currentMinute < 8))) {
                document.getElementById('backtestCard').style.display = 'block';
                document.getElementById('backtestDate').textContent = 'ç­‰å¾…æ•°æ®æ›´æ–°ï¼ˆæ¯å¤©20:08æ›´æ–°ï¼‰';

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                document.getElementById('avgReturn').textContent = '--';
                document.getElementById('avgReturn').className = 'stat-value';
                document.getElementById('avgReturnTrend').textContent = '20:08åæ›´æ–°';

                document.getElementById('winRate').textContent = '--';
                document.getElementById('winRate').className = 'stat-value';
                document.getElementById('winRateTrend').textContent = '20:08åæ›´æ–°';

                document.getElementById('winLoseRatio').textContent = '--';
                document.getElementById('winLoseRatio').className = 'stat-value';
                document.getElementById('winLoseTrend').textContent = '20:08åæ›´æ–°';

                document.getElementById('validCount').textContent = '--';
                document.getElementById('validCountTrend').textContent = '20:08åæ›´æ–°';
                return;
            }

            try {
                // è·å–æŒ‡å®šæ—¥æœŸçš„å›æµ‹ç»“æœ
                // é€»è¾‘ï¼šé€‰è‚¡æ—¥æœŸD â†’ æ¬¡æ—¥å–å‡ºï¼ˆè·³è¿‡å‘¨æœ«ï¼‰â†’ æŸ¥è¯¢è¯¥å–å‡ºæ—¥æœŸçš„å›æµ‹æ•°æ®
                // ä¾‹å¦‚ï¼š11-28(å‘¨äº”)é€‰è‚¡ â†’ 12-01(å‘¨ä¸€)å–å‡º â†’ æŸ¥è¯¢12-01çš„å›æµ‹æ•°æ®
                const selectDate = new Date(selectedDate);
                let nextDate = new Date(selectDate);

                // å¾ªç¯æ‰¾åˆ°ä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰
                // JavaScriptä¸­ï¼šgetDay() è¿”å› 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
                do {
                    nextDate.setDate(nextDate.getDate() + 1);
                    const dayOfWeek = nextDate.getDay();
                    // äº¤æ˜“æ—¥ï¼šå‘¨ä¸€(1)åˆ°å‘¨äº”(5)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        break;
                    }
                } while (true);

                const nextDateStr = nextDate.toISOString().split('T')[0];

                const response = await fetch(`/api/backtest/results?strategy=${strategy}&date=${nextDateStr}&limit=1`);
                const res = await response.json();

                if (res.code === 0 && res.data.results && res.data.results.length > 0) {
                    const result = res.data.results[0];

                    // æ˜¾ç¤ºå›æµ‹å¡ç‰‡
                    document.getElementById('backtestCard').style.display = 'block';

                    // ç­‰å¾…DOMæ›´æ–°åå†æ“ä½œæŒ‰é’®
                    setTimeout(() => {
                        // ä¿å­˜detailsæ•°æ®å¹¶æ˜¾ç¤º"è¯¦ç»†"æŒ‰é’®
                        console.log('å›æµ‹ç»“æœ result:', result);
                        console.log('detailså­—æ®µ:', result.details);
                        console.log('detailsç±»å‹:', typeof result.details);

                        if (result.details) {
                            try {
                                window.currentBacktestDetails = JSON.parse(result.details);
                                console.log('è§£æåçš„details:', window.currentBacktestDetails);
                                const btn = document.getElementById('detailsBtn');
                                console.log('æ‰¾åˆ°çš„æŒ‰é’®å…ƒç´ :', btn);
                                if (btn) {
                                    btn.style.display = 'inline-block';
                                    console.log('å·²æ˜¾ç¤ºè¯¦ç»†æŒ‰é’®');
                                } else {
                                    console.error('æ‰¾ä¸åˆ°detailsBtnå…ƒç´ ');
                                }
                            } catch (e) {
                                console.error('è§£ædetailså¤±è´¥:', e);
                                window.currentBacktestDetails = null;
                            }
                        } else {
                            console.log('æ²¡æœ‰detailsæ•°æ®');
                            window.currentBacktestDetails = null;
                        }
                    }, 100);

                    // è®¡ç®—é€‰è‚¡æ—¥æœŸï¼ˆå–å‡ºæ—¥æœŸçš„å‰ä¸€å¤©ï¼‰
                    const sellDate = new Date(result.date);
                    const selectDate = new Date(sellDate);
                    selectDate.setDate(selectDate.getDate() - 1);
                    const selectDateStr = selectDate.toISOString().split('T')[0];

                    // æ›´æ–°æ—¥æœŸè¯´æ˜
                    document.getElementById('backtestDate').textContent = `${selectDateStr} é€‰è‚¡ â†’ ${result.date} å–å‡º`;

                    // æ›´æ–°æ—¥å‡æ”¶ç›Š
                    const avgReturn = result.avg_return;
                    const avgReturnEl = document.getElementById('avgReturn');
                    avgReturnEl.textContent = avgReturn >= 0 ? `+${avgReturn.toFixed(2)}%` : `${avgReturn.toFixed(2)}%`;
                    avgReturnEl.className = 'stat-value ' + (avgReturn >= 0 ? 'positive' : 'negative');
                    document.getElementById('avgReturnTrend').textContent = avgReturn >= 0 ? 'â†‘ ç›ˆåˆ©' : 'â†“ äºæŸ';

                    // æ›´æ–°èƒœç‡
                    const winRate = result.win_rate;
                    const winRateEl = document.getElementById('winRate');
                    winRateEl.textContent = `${winRate.toFixed(1)}%`;
                    winRateEl.className = 'stat-value ' + (winRate >= 50 ? 'positive' : 'negative');
                    document.getElementById('winRateTrend').textContent = `${result.win_count}èƒœ / ${result.lose_count}è´Ÿ`;

                    // æ›´æ–°ç›ˆäºæ¯”
                    const winLoseRatio = result.lose_count > 0 ? (result.win_count / result.lose_count).toFixed(2) : result.win_count.toFixed(2);
                    const winLoseRatioEl = document.getElementById('winLoseRatio');
                    winLoseRatioEl.textContent = winLoseRatio;
                    winLoseRatioEl.className = 'stat-value ' + (winLoseRatio >= 1 ? 'positive' : 'negative');
                    document.getElementById('winLoseTrend').textContent = winLoseRatio >= 1 ? 'â†‘ ä¼˜åŠ¿' : 'â†“ åŠ£åŠ¿';

                    // æ›´æ–°æœ‰æ•ˆæ ·æœ¬æ•°
                    document.getElementById('validCount').textContent = result.valid_count;
                    document.getElementById('validCountTrend').textContent = `åŸé€‰${result.stock_count}åª`;
                } else {
                    // æ²¡æœ‰å›æµ‹æ•°æ®ï¼Œéšè—å¡ç‰‡
                    document.getElementById('backtestCard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading backtest results:', error);
                document.getElementById('backtestCard').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå›æµ‹è¯¦æƒ…å¼¹çª—
        function showBacktestDetails() {
            if (!window.currentBacktestDetails) {
                alert('æš‚æ— è¯¦ç»†æ•°æ®');
                return;
            }

            const details = window.currentBacktestDetails;
            const modal = document.getElementById('backtestModal');

            // å¡«å……ç›ˆåˆ©è‚¡ç¥¨
            const winStocksList = document.getElementById('winStocksList');
            const winStocks = details.win_stocks || [];
            document.getElementById('winStocksCount').textContent = winStocks.length;

            if (winStocks.length > 0) {
                winStocksList.innerHTML = winStocks.map(stock => `
                    <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; color: var(--text-primary);">${stock.name}</span>
                            <span style="color: var(--text-secondary); margin-left: 8px; font-size: 0.875rem;">${stock.code}</span>
                        </div>
                        <span style="color: var(--success-color); font-weight: 600; font-size: 1.1rem;">+${stock.pnl.toFixed(2)}%</span>
                    </div>
                `).join('');
            } else {
                winStocksList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">æ— </p>';
            }

            // å¡«å……äºæŸè‚¡ç¥¨
            const loseStocksList = document.getElementById('loseStocksList');
            const loseStocks = details.lose_stocks || [];
            document.getElementById('loseStocksCount').textContent = loseStocks.length;

            if (loseStocks.length > 0) {
                loseStocksList.innerHTML = loseStocks.map(stock => `
                    <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; color: var(--text-primary);">${stock.name}</span>
                            <span style="color: var(--text-secondary); margin-left: 8px; font-size: 0.875rem;">${stock.code}</span>
                        </div>
                        <span style="color: var(--danger-color); font-weight: 600; font-size: 1.1rem;">${stock.pnl.toFixed(2)}%</span>
                    </div>
                `).join('');
            } else {
                loseStocksList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">æ— </p>';
            }

            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
        }

        // å…³é—­å›æµ‹è¯¦æƒ…å¼¹çª—
        function closeBacktestDetails() {
            document.getElementById('backtestModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('backtestModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeBacktestDetails();
            }
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥è¯¢
        console.log('=== TDX Strategy Page v2.0 - å¸¦å›æµ‹è¯¦æƒ… ===');
        loadResults();
        loadBacktestResults();
    </script>
</body>

</html>